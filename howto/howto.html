<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to use &mdash; pyCompressor 1.1.0-dev documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="pycompressor" href="../modules/pycompressor/modules.html" />
    <link rel="prev" title="Statistical Estimators" href="../theory/estimators.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> pyCompressor
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/introduction.html">Why pyCompressor?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/introduction.html#benchmarks">Benchmarks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Theory</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../theory/estimators.html">Statistical Estimators</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HowTo</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">How to use</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#running-gans-within-pycompressor">Running GANs within pyCompressor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adiabatic-minimization">Adiabatic minimization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pdf-grid-and-validation-plot">PDF grid and Validation plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="#controlling-the-parallelization">Controlling the parallelization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/pycompressor/modules.html">pycompressor</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pyCompressor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>How to use</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/howto/howto.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-use">
<h1>How to use<a class="headerlink" href="#how-to-use" title="Permalink to this headline"></a></h1>
<p>Once the <strong>pyCompressor</strong> package is installed, runnig a compression is very easy. It just takes
an input run card in which all the input parameters are defined. The run card is subdivided into
two distincts part: the compression and the GANs parameters.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pycompressor runcards/runcard.yml <span class="o">[</span>--threads NUMB_THREADS<span class="o">]</span>
</pre></div>
</div>
<p>The compression per-say requires the following keys:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pdf</span></code> - <em>str</em> : name of the inpit/prior PDF set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compressed</span></code> - <em>int</em> : size of the compressed replicas</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minimizer</span></code> - <em>str</em> : name of the minimizer (<cite>genetic</cite> or <cite>cma</cite>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">est_dic</span></code> - <em>dict</em> : dictionary of estimators</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gans</span></code> - <em>dict</em> : dictionary containing input parameters for GANs</p></li>
</ul>
</div></blockquote>
<p>One of the keys for the <code class="docutils literal notranslate"><span class="pre">gan</span></code> entry is a <code class="docutils literal notranslate"><span class="pre">runcard</span></code> which gets passed to the <em>ganpdfs</em> code.
For details on how to set the parameters for the GAN, have a look <a class="reference external" href="https://n3pdf.github.io/ganpdfs/howto/howto.html">here</a>.</p>
<p>An example of an input card is shown below:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1">###################################################</span><span class="w"></span>
<span class="c1"># PDF Set                                         #</span><span class="w"></span>
<span class="c1">###################################################</span><span class="w"></span>
<span class="nt">pdfsetting</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">pdf</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NNPDF40_nnlo_as_0118_1000</span><span class="w"></span>
<span class="w">  </span><span class="nt">existing_enhanced</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span><span class="w"></span>

<span class="c1">###################################################</span><span class="w"></span>
<span class="c1"># Size of compressed PDF replicas                 #</span><span class="w"></span>
<span class="c1">###################################################</span><span class="w"></span>
<span class="nt">compressed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500</span><span class="w"></span>

<span class="c1">###################################################</span><span class="w"></span>
<span class="c1"># Choice of Minimizer                             #</span><span class="w"></span>
<span class="c1"># Options:                                        #</span><span class="w"></span>
<span class="c1">#   - genetic                                     #</span><span class="w"></span>
<span class="c1">#   - cma                                         #</span><span class="w"></span>
<span class="c1">###################################################</span><span class="w"></span>
<span class="nt">minimizer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">genetic</span><span class="w"></span>

<span class="c1">###################################################</span><span class="w"></span>
<span class="c1"># Statistical Estimators                          #</span><span class="w"></span>
<span class="c1"># Extra-options for Moment:                       #</span><span class="w"></span>
<span class="c1">#   - moment5th                                   #</span><span class="w"></span>
<span class="c1">#   - moment6th                                   #</span><span class="w"></span>
<span class="c1">###################################################</span><span class="w"></span>
<span class="nt">est_dic</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">corr_estimators</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">correlation</span><span class="w"></span>
<span class="w">  </span><span class="nt">stat_estimators</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kolmogorov_smirnov</span><span class="w"></span>
<span class="w">  </span><span class="nt">moment_estimators</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mean</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stdev</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">skewness</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kurtosis</span><span class="w"></span>

<span class="c1">###################################################</span><span class="w"></span>
<span class="c1"># Enhance statistics of Prior                     #</span><span class="w"></span>
<span class="c1">###################################################</span><span class="w"></span>
<span class="nt">gans  </span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">enhance </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span><span class="w"></span>
<span class="w">  </span><span class="nt">runcard </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ganpdfs</span><span class="w"></span>
<span class="w">  </span><span class="nt">total_replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span><span class="w"></span>
</pre></div>
</div>
<section id="running-gans-within-pycompressor">
<h2>Running GANs within pyCompressor<a class="headerlink" href="#running-gans-within-pycompressor" title="Permalink to this headline"></a></h2>
<p>Although it is advised to run the <cite>ganpdfs</cite> code independently, it is possible to call it
within the <cite>pyCompressor</cite> code by setting <code class="docutils literal notranslate"><span class="pre">enhance</span></code> to <cite>True</cite> in the runcard. In this
scenario, the code will first enhance the statistic the prior using GANs.
Once the generation of the extra-replicas is finished, the output grids are evolved using
<a class="reference external" href="https://github.com/NNPDF/nnpdf/blob/master/n3fit/evolven3fit/evolven3fit.cc">evolven3fit</a>.
Then, the <code class="xref py py-mod docutils literal notranslate"><span class="pre">pyCompressor.postgans</span></code> module (in a similar fashion as postfit) creates a
symbolic link of both the original and the generated PDF sets into the LHAPDF data directory.
The new enhanced Monte Carlo set of PDF replicas is then used as input to the compressor.
Once the compression is finished, a folder is created in the main directory with the folowing
structure:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;PRIOR_PDF_NAME&gt;_enhanced
├── filter.yml
├── input-runcard.json
├── losses_info.json
├── nnfit
│    ├── &lt;PDF_NAME&gt;_enhanced.info
│    ├── replica_&lt;REPLICA_INDEX&gt;
│    │   ├── &lt;PDF_NAME&gt;_enhanced.dat
│    │   └── &lt;PDF_NAME&gt;.exportgrid
│    └── ...
└── compress_&lt;PRIOR_PDF_NAME&gt;_enhanced_&lt;NB_COMPRESSED_REPLICAS&gt;_output.dat
</pre></div>
</div>
<p>where:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>losses_info.json</strong> stores the losses of the generator and the critic/discriminator for the
GANs model.</p></li>
<li><p><strong>filter.yml</strong> contains the information on the theory ID use to reproduce the prior replicas.</p></li>
<li><p><strong>input-runcard.json</strong> is a copy of the input parameters that were fed to the GANs.</p></li>
<li><p><strong>nnfit</strong> has more or less the same folder structure as the output from n3fit. It contains the
a <cite>replica_$REPLICA_INDEX</cite> that contains a <cite>.exportgrid</cite> file used by evolven3fit for the
evolution. That is where the evolved grid in the format <cite>.dat</cite> is also stored.</p></li>
<li><p><strong>compress_&lt;PDF_NAME&gt;_enhanced_&lt;NB_COMPRESSED_REPLICAS&gt;_output.dat</strong> contains the index of
the reduced replicas along with the final ERF value.</p></li>
</ul>
</div></blockquote>
<p>If <code class="docutils literal notranslate"><span class="pre">enhance</span></code> is instead set to <cite>False</cite>, the folder will just simply be:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;PRIOR_PDF_NAME&gt;_enhanced
└── compress_&lt;PRIOR_PDF_NAME&gt;_enhanced_&lt;NB_COMPRESSED_REPLICAS&gt;_output.dat
</pre></div>
</div>
</section>
<section id="adiabatic-minimization">
<h2>Adiabatic minimization<a class="headerlink" href="#adiabatic-minimization" title="Permalink to this headline"></a></h2>
<p>Since compressing from an enhanced set could be difficult due to the limitation of the minimization
algorithm, it is possible to perfrom an adiabatic minimization by setting <code class="docutils literal notranslate"><span class="pre">existing_enhanced</span></code> to
<cite>True</cite> in the runcard. In this case, the minimization is perfromed in two steps: (1) a standard
compression of the prior, (2) a compression using the enhanced set but using as a starting point
the space in which the best from the standard compression was generated.</p>
</section>
</section>
<section id="pdf-grid-and-validation-plot">
<h1>PDF grid and Validation plot<a class="headerlink" href="#pdf-grid-and-validation-plot" title="Permalink to this headline"></a></h1>
<p>To generate the reduced Monte Carlo set of PDF replicas, simply run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>get-grid -i &lt;PRIOR_PDF_NAME&gt;/compressed_&lt;PDF_NAME&gt;_&lt;NB_COMPRESSED&gt;_output.dat
</pre></div>
</div>
<p>Note that if the compression is done from an enhanced set, the output folder will be append by <strong>_enhanced</strong>.</p>
<p>Finally, to check that the reduced Monte Carlo set indeed faithfully reproduces the statistics of the
prior, ERF plots for each of the estimator can be generated and compared to a random selection. To generate
the ERF validation plots, enter in the <code class="docutils literal notranslate"><span class="pre">erfs_output</span></code> folder and run the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>validate --random erf_randomized.dat --reduced erf_reduced.dat
</pre></div>
</div>
</section>
<section id="controlling-the-parallelization">
<h1>Controlling the parallelization<a class="headerlink" href="#controlling-the-parallelization" title="Permalink to this headline"></a></h1>
<p>The backend of pycompressor is the JIT compiler [numba](<a class="reference external" href="https://numba.pydata.org">https://numba.pydata.org</a>) and it is numba who controls the parallelization of the calculations within the code.
The number of cores to be used can be controlled with the appropiate settings to the following environmental variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">4</span>
<span class="nb">export</span> <span class="nv">MKL_NUM_THREADS</span><span class="o">=</span><span class="m">4</span>
<span class="nb">export</span> <span class="nv">NUMBA_NUM_THREADS</span><span class="o">=</span><span class="m">4</span>
</pre></div>
</div>
<p>An interface to control the numba number of threads is also provided as the command line argument <code class="docutils literal notranslate"><span class="pre">threads</span></code>.
Note that in no case can <code class="docutils literal notranslate"><span class="pre">threads</span></code> be greater than the environmental variable (if given) <code class="docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pycomp runcards/runcard.yml --threads <span class="m">4</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../theory/estimators.html" class="btn btn-neutral float-left" title="Statistical Estimators" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../modules/pycompressor/modules.html" class="btn btn-neutral float-right" title="pycompressor" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Stefano Carrazza, Juan Cruz-Martinez, Tanjona R. Rabemananjara.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>