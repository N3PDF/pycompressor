

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to use &mdash; pyCompressor 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="pycompressor" href="../modules/pycompressor/modules.html" />
    <link rel="prev" title="Statistical Estimators" href="../theory/estimators.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> pyCompressor
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/introduction.html">Why pyCompressor?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/introduction.html#benchmarks">Benchmarks</a></li>
</ul>
<p class="caption"><span class="caption-text">Theory</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../theory/estimators.html">Statistical Estimators</a></li>
</ul>
<p class="caption"><span class="caption-text">HowTo</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">How to use</a></li>
<li class="toctree-l1"><a class="reference internal" href="#post-run">Post-run</a></li>
</ul>
<p class="caption"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/pycompressor/modules.html">pycompressor</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pyCompressor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>How to use</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/howto/howto.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-use">
<h1>How to use<a class="headerlink" href="#how-to-use" title="Permalink to this headline">Â¶</a></h1>
<p>Once the <strong>pyCompressor</strong> package is installed, runnig a compression is very easy. It just takes
an input run card in which all the input parameters are defined. The run card is subdivided into
two distincts part: the compression and the GANs parameters.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pycompressor runcard.yml
</pre></div>
</div>
<p>The compression per-say requires the following keys:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pdf</span></code> - <em>str</em> : name of the inpit/prior PDF set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compressed</span></code> - <em>int</em> : size of the compressed replicas</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minimizer</span></code> - <em>str</em> : name of the minimizer (<cite>genetic</cite> or <cite>cma</cite>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">est_dic</span></code> - <em>dict</em> : dictionary of estimators</p></li>
</ul>
</div></blockquote>
<p>The GANs requires has the following keys:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">enhance</span></code> - <em>bool</em> : switch on/off GANs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nbgeng</span></code> - <em>int</em> : total number of output replicas (this includes the prior)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">q</span></code> - <em>float</em> : initiale at which the PDF grid will be generated</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x_grid</span></code> - <em>str</em> : choose between the built-in GANs grid or the LHAPDF-grid from the
PDF file (options: <cite>custom</cite> or <cite>lhapdf</cite>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">architecture</span></code> - <em>str</em> : define the architecture; <cite>dcnn</cite> for deep convolutional neural
network, <cite>dnn</cite> for deep neural network</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">g_nodes</span></code> - <em>int</em> : number of nodes in the first hidden layer for the generator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">d_nodes</span></code> - <em>int</em> : number of nodes in the first hidden layer for the critic/discriminator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">g_act</span></code> - <em>str</em> : name of the activation function for the generator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">d_act</span></code> - <em>str</em> : name of the activation function for the critic/discriminator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">d_opt</span></code> - <em>str</em> : name of the optimizer for the critic/discriminator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gan_opt</span></code> - <em>str</em> : name of the optimizer for the adversarial</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">epochs</span></code> - <em>int</em> : number of epochs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code> - <em>int</em> : number of batches per epoch</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ng_steps</span></code> - <em>int</em> : number of intermediate steps to train the generator</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nd_steps</span></code> - <em>int</em> : number of intermediate steps to train the critic/discriminator</p></li>
</ul>
</div></blockquote>
<p>An example of run card is shown below:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pyCompressor input parameters</span>
<span class="nt">pdf</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PN3_GLOBAL_NNPDF31_nnlo_as_0118_070219-001</span>
<span class="nt">compressed</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="nt">minimizer</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">genetic</span>
<span class="nt">est_dic</span><span class="p">:</span>
     <span class="nt">corr_estimators</span><span class="p">:</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">correlation</span>
     <span class="nt">stat_estimators</span><span class="p">:</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">kolmogorov_smirnov</span>
     <span class="nt">moment_estimators</span><span class="p">:</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mean</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">stdev</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">skewness</span>
       <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">kurtosis</span>

 <span class="c1"># GANs input parameters</span>
<span class=" -Error"> </span><span class="nt">enhance  </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
 <span class="nt">nbgen    </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
 <span class="nt">q        </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.65</span>
 <span class="nt">x_grid   </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">custom</span>
 <span class="nt">architecture</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dcnn</span>
 <span class="nt">g_nodes  </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">256</span>
 <span class="nt">d_nodes  </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">128</span>
 <span class="nt">g_act    </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">leakyrelu</span>
 <span class="nt">d_act    </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">leakyrelu</span>
 <span class="nt">d_opt    </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rms</span>
 <span class="nt">gan_opt  </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rms</span>
 <span class="nt">epochs   </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5000</span>
 <span class="nt">batch_size </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">32</span>
 <span class="nt">nd_steps </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
 <span class="nt">ng_steps </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">enhance</span></code> is set to <cite>True</cite>, the code will first enhance the statistic the prior using GANs.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>+-------------------------------------------------------------------------+
<span class="p">|</span>ğ–Œğ–†ğ–“ğ–•ğ–‰ğ–‹ğ–˜:                                                                 <span class="p">|</span>
<span class="p">|</span>-------                                                                  <span class="p">|</span>
<span class="p">|</span>Generative Adversarial Neural Networks <span class="o">(</span>GANs<span class="o">)</span> <span class="k">for</span> PDF replicas.          <span class="p">|</span>
<span class="p">|</span>https://n3pdf.github.io/ganpdfs/                                         <span class="p">|</span>
<span class="p">|</span>Â© N3PDF                                                                  <span class="p">|</span>
+-------------------------------------------------------------------------+
</pre></div>
</div>
<p>Once the generation of the extra-replicas is finished, the output grids are evolved using
<a class="reference external" href="https://github.com/NNPDF/nnpdf/blob/master/n3fit/evolven3fit/evolven3fit.cc">evolven3fit</a>.
Then, the <code class="xref py py-mod docutils literal notranslate"><span class="pre">pyCompressor.postgans</span></code> module (in a similar fashion as postfit) creates a
symbolic link of both the original and the generated PDF sets into the LHAPDF data directory.
The new enhanced Monte Carlo set of PDF replicas is then used as input to the compressor.
Once the compression is finished, a folder is created in the main directory with the folowing
structure</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;PDF_NAME&gt;_enhanced
â”œâ”€â”€ checkpoint
â”‚   â”œâ”€â”€ checkpoint
â”‚   â”œâ”€â”€ ckpt-1.data-00000-of-00001
â”‚   â””â”€â”€ ckpt-1.index
â”‚   â””â”€â”€ ...
â”œâ”€â”€ filter.yml
â”œâ”€â”€ input-runcard.json
â”œâ”€â”€ iterations
â”‚   â””â”€â”€ pdf_generated_at_&lt;ITERATION&gt;.png
â”‚   â””â”€â”€ ...
â”œâ”€â”€ losses_info.json
â”œâ”€â”€ nnfit
â”‚    â”œâ”€â”€ &lt;PDF_NAME&gt;_enhanced.info
â”‚    â”œâ”€â”€ replica_&lt;REPLICA_INDEX&gt;
â”‚    â”‚   â”œâ”€â”€ &lt;PDF_NAME&gt;_enhanced.dat
â”‚    â”‚   â””â”€â”€ &lt;PDF_NAME&gt;.exportgrid
â”‚    â””â”€â”€ ...
â””â”€â”€ compress_&lt;PDF_NAME&gt;_enhanced_&lt;NB_COMPRESSED_REPLICAS&gt;_output.dat
</pre></div>
</div>
<p>where:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>checkpoint</strong> stores the evolution of the GANs training. In case a long runnning training is
interupted, the last checkpoint can be restored and the training can re-start from there</p></li>
<li><p><strong>iterations</strong> contains the evolution of the GANs training for every given iteration step.</p></li>
<li><p><strong>losses_info.json</strong> stores the losses of the generator and the critic/discriminator for the
GANs model.</p></li>
<li><p><strong>filter.yml</strong> contains the information on the theory ID use to reproduce the prior replicas.</p></li>
<li><p><strong>input-runcard.json</strong> is a copy of the input parameters that were fed to the GANs.</p></li>
<li><p><strong>nnfit</strong> has more or less the same folder structure as the output from n3fit. It contains the
a <cite>replica_$REPLICA_INDEX</cite> that contains a <cite>.exportgrid</cite> file used by evolven3fit for the
evolution. That is where the evolved grid in the format <cite>.dat</cite> is also stored.</p></li>
<li><p><strong>compress_&lt;PDF_NAME&gt;_enhanced_&lt;NB_COMPRESSED_REPLICAS&gt;_output.dat</strong> contains the index of
the reduced replicas along with the final ERF value.</p></li>
</ul>
</div></blockquote>
<p>If <code class="docutils literal notranslate"><span class="pre">enhance</span></code> is instead set to <cite>False</cite>, the folder would just simply be:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;PDF_NAME&gt;_enhanced
â””â”€â”€ compress_&lt;PDF_NAME&gt;_enhanced_&lt;NB_COMPRESSED_REPLICAS&gt;_output.dat
</pre></div>
</div>
</div>
<div class="section" id="post-run">
<h1>Post-run<a class="headerlink" href="#post-run" title="Permalink to this headline">Â¶</a></h1>
<p>To generate the reduced Monte Carlo set of PDF replicas, simply run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./tools/compressed_grid.py &lt;PDF_NAME&gt;<span class="o">(</span>_enhanced<span class="o">)</span>/compressed_&lt;PDF_NAME&gt;<span class="o">(</span>_enhanced<span class="o">)</span>_&lt;NB_COMPRESSED&gt;_output.dat
</pre></div>
</div>
<p>Finally, to check that the reduced Monte Carlo set indeed faithfully reproduces the statistics of the
prior, ERF plots for each of the estimator can be generated and compared to a random selection. For
the time, this is done using root, but this will be changed by a python script. To generate the ERF
plots, copy the <cite>compressor_validate.C</cite> file in tools into the <cite>erfs_output</cite> folder and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>root -l compressor_validate.C
</pre></div>
</div>
<p>This will generate the following ERF plots:</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/erf_validation.png" src="../_images/erf_validation.png" />
</div>
</div></blockquote>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../modules/pycompressor/modules.html" class="btn btn-neutral float-right" title="pycompressor" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../theory/estimators.html" class="btn btn-neutral float-left" title="Statistical Estimators" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Stefano Carrazza, Juan Cruz-Martinez, Tanjona R. Rabemananjara

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>